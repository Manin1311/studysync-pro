{% extends "base.html" %}

{% block title %}Study Partners - StudySync Pro{% endblock %}
{% block header %}Find Study Partners ðŸ‘¥{% endblock %}

{% block content %}
<div class="dashboard-grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Find Partners Section -->
    <div>
        <div class="glass-panel mb-2">
            <h2>Recommended for You</h2>
            <p class="text-muted">We found these students who share similar courses with you.</p>
        </div>

        <div id="matchesGrid" class="dashboard-grid"
            style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
            <div class="glass-panel text-center">Finding matches...</div>
        </div>
    </div>

    <!-- Your Connections Section -->
    <div class="glass-panel" style="height: fit-content;">
        <h3>Your Connections</h3>
        <div id="connectionsList" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
            <div class="text-center text-muted">Loading connections...</div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        findMatches();
        loadConnections();
    });

    async function findMatches() {
        try {
            const res = await fetch('/api/partners/find');
            const data = await res.json();

            const grid = document.getElementById('matchesGrid');
            grid.innerHTML = '';

            if (data.partners.length === 0) {
                grid.innerHTML = `
                    <div class="glass-panel text-center" style="grid-column: 1/-1; padding: 3rem;">
                        <i class="fa-solid fa-users-slash" style="font-size: 3rem; margin-bottom: 1rem; color: var(--glass-border);"></i>
                        <h3>No matches found yet</h3>
                        <p class="text-muted">Join more courses or add notes to help us find matches!</p>
                    </div>`;
                return;
            }

            data.partners.forEach(p => {
                if (p.status !== 'none') return; // Only show non-connected users

                const card = document.createElement('div');
                card.className = 'glass-panel text-center';
                card.innerHTML = `
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--col-primary), var(--col-accent)); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <h4>${p.email.split('@')[0]}</h4>
                    <div class="badge mt-1 mb-1" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">
                        ${p.match_score}% Match
                    </div>
                    <p class="text-muted" style="font-size: 0.9rem;">${p.shared_courses} Shared Courses</p>
                    
                    <button class="btn btn-primary mt-2" onclick="sendRequest(${p.user_id})" style="width: 100%;">Connect</button>
                `;
                grid.appendChild(card);
            });
        } catch (e) { console.error(e); }
    }

    async function loadConnections() {
        try {
            const res = await fetch('/api/partners');
            const data = await res.json();

            const list = document.getElementById('connectionsList');
            list.innerHTML = '';

            if (data.partners.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No active connections.</div>';
                return;
            }

            data.partners.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex-between';
                item.style.padding = '0.75rem';
                item.style.background = 'rgba(255,255,255,0.03)';
                item.style.borderRadius = '8px';

                let actionBtn = '';
                if (p.status === 'pending' && p.user_id !== p.partner_id) { // This logic is simplified, backend handles auth
                    // We need to know who sent it. For now assuming if pending it might be incoming or outgoing
                    // The backend returns uniform structure, we'd need extra field to know direction.
                    // For now, simpler to just show status.
                }

                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 32px; height: 32px; background: var(--glass-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-user" style="font-size: 0.8rem;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 500;">${p.partner_email.split('@')[0]}</div>
                            <div style="font-size: 0.75rem; color: var(--col-text-muted); text-transform: capitalize;">${p.status}</div>
                        </div>
                    </div>
                    ${p.status === 'pending' ? '<i class="fa-solid fa-clock text-muted"></i>' : '<a href="/rooms" class="btn btn-glass" style="padding: 0.25rem 0.5rem;"><i class="fa-solid fa-video"></i></a>'}
                `;
                list.appendChild(item);
            });
        } catch (e) { console.error(e); }
    }

    async function sendRequest(userId) {
        try {
            const res = await fetch('/api/partners/request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ partner_id: userId })
            });

            if (res.ok) {
                showToast('Connection request sent!', 'success');
                findMatches();
                loadConnections();
            } else {
                showToast('Failed to send request', 'error');
            }
        } catch (e) {
            showToast('Error sending request', 'error');
        }
    }
</script>
{% endblock %}