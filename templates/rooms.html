{% extends "base.html" %}

{% block title %}Study Rooms - StudySync Pro{% endblock %}
{% block header %}Collaborative Study Rooms ðŸŽ¥{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Lobby / Room Selection -->
    <div id="lobbyView" class="glass-panel" style="grid-column: 1/-1; padding: 1.5rem;">
        <h3 class="mb-1">Active Study Rooms</h3>
        <p class="text-muted" style="margin-bottom: 2rem;">Join a room to chat and brainstorm on the whiteboard.</p>

        <div class="rooms-container"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
            <!-- Mock Rooms -->
            <div class="room-card" onclick="joinRoom('DSA_Group_1')"
                style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: 0.2s;">
                <div class="flex-between mb-1">
                    <strong style="font-size: 1.1rem;">DSA Group 1</strong>
                    <span
                        style="background: var(--col-success); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Live</span>
                </div>
                <p class="text-muted">Data Structures discussion</p>
                <div
                    style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--col-text-muted); font-size: 0.9rem;">
                    <i class="fa-solid fa-users"></i> 3 Online
                </div>
            </div>

            <div class="room-card" onclick="joinRoom('System_Design')"
                style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: 0.2s;">
                <div class="flex-between mb-1">
                    <strong style="font-size: 1.1rem;">System Design</strong>
                    <span
                        style="background: var(--col-success); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Live</span>
                </div>
                <p class="text-muted">High level architecture</p>
                <div
                    style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--col-text-muted); font-size: 0.9rem;">
                    <i class="fa-solid fa-users"></i> 5 Online
                </div>
            </div>
            <div class="room-card" onclick="joinRoom('Chill_Study')"
                style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: 0.2s;">
                <div class="flex-between mb-1">
                    <strong style="font-size: 1.1rem;">Chill Study</strong>
                    <span
                        style="background: var(--col-warning); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Quiet</span>
                </div>
                <p class="text-muted">Pomodoro focus session</p>
                <div
                    style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; color: var(--col-text-muted); font-size: 0.9rem;">
                    <i class="fa-solid fa-users"></i> 1 Online
                </div>
            </div>
        </div>
    </div>

    <!-- Active Room View (Hidden by default) -->
    <div id="roomView"
        style="display: none; grid-column: 1/-1; height: 80vh; grid-template-columns: 1fr 350px; gap: 1rem;">
        <!-- Whiteboard Area -->
        <div class="glass-panel" style="padding: 1rem; display: flex; flex-direction: column;">
            <div class="flex-between mb-1">
                <h4 id="currentRoomName">Room Name</h4>
                <div class="flex-center gap-sm">
                    <button class="btn btn-glass btn-sm" onclick="clearBoard()"><i class="fa-solid fa-eraser"></i>
                        Clear</button>
                    <button class="btn btn-primary btn-sm" style="background: var(--col-danger);"
                        onclick="leaveRoom()">Leave Room</button>
                </div>
            </div>
            <div
                style="flex: 1; background: white; border-radius: 8px; overflow: hidden; position: relative; cursor: crosshair;">
                <canvas id="whiteboard" style="width: 100%; height: 100%;"></canvas>
            </div>
            <div class="flex-center gap-sm" style="margin-top: 1rem;">
                <p class="text-muted" style="font-size: 0.8rem;">Use your mouse to draw on the whiteboard. Real-time
                    synced.</p>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="glass-panel" style="display: flex; flex-direction: column;">
            <div class="chat-header" style="padding: 1rem; border-bottom: 1px solid var(--glass-border);">
                <h4>Live Chat</h4>
                <span id="userCount" class="text-muted" style="font-size: 0.8rem;">0 Users</span>
            </div>

            <div id="chatMessages"
                style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem;">
                <!-- Messages -->
            </div>

            <div class="chat-input" style="padding: 1rem; border-top: 1px solid var(--glass-border);">
                <form id="chatForm" class="flex-center gap-sm">
                    <input type="text" id="msgInput" class="form-input" placeholder="Type a message..." required>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    let socket;
    let currentRoom = null;
    let username = "User_" + Math.floor(Math.random() * 1000); // Placeholder until we get real username from backend template var

    // Canvas vars
    const canvas = document.getElementById('whiteboard');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Initialize Canvas
    function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);

    function joinRoom(roomId) {
        document.getElementById('lobbyView').style.display = 'none';
        document.getElementById('roomView').style.display = 'grid';
        document.getElementById('currentRoomName').textContent = roomId.replace(/_/g, ' ');

        resizeCanvas();

        currentRoom = roomId;

        // Connect Socket
        socket = io();

        socket.on('connect', () => {
            // We need current_user.email or name from server. For now using placeholder or if stored in DOM
            // Better: Let server handle user info from session
            socket.emit('join', { username: username, room_id: currentRoom });
        });

        socket.on('status', (data) => {
            addSystemMessage(data.msg);
        });

        socket.on('message', (data) => {
            addMessage(data.username, data.msg, data.timestamp);
        });

        socket.on('draw', (data) => {
            drawLine(data.x0, data.y0, data.x1, data.y1, false);
        });

        socket.on('clear_board', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
    }

    function leaveRoom() {
        if (socket) {
            socket.emit('leave', { username: username, room_id: currentRoom });
            socket.disconnect();
        }
        document.getElementById('roomView').style.display = 'none';
        document.getElementById('lobbyView').style.display = 'block';
        currentRoom = null;
    }

    // Chat Logic
    document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('msgInput');
        const msg = input.value;
        if (msg.trim()) {
            socket.emit('message', {
                room_id: currentRoom,
                username: username,
                msg: msg
            });
            input.value = '';
        }
    });

    function addMessage(user, text, time) {
        const div = document.createElement('div');
        div.className = 'chat-msg';
        div.style.background = 'rgba(255,255,255,0.05)';
        div.style.padding = '0.5rem 0.8rem';
        div.style.borderRadius = '8px';
        div.style.maxWidth = '90%';

        if (user === username) {
            div.style.alignSelf = 'flex-end';
            div.style.background = 'var(--col-primary-dark)';
        }

        div.innerHTML = `
            <div style="font-size: 0.75rem; color: var(--col-text-muted); display: flex; justify-content: space-between; gap: 1rem;">
                <strong>${user}</strong> <span>${time}</span>
            </div>
            <div style="margin-top: 0.2rem;">${text}</div>
        `;

        const container = document.getElementById('chatMessages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.style.textAlign = 'center';
        div.style.fontSize = '0.8rem';
        div.style.color = 'var(--col-text-muted)';
        div.style.margin = '0.5rem 0';
        div.textContent = text;
        document.getElementById('chatMessages').appendChild(div);
    }

    // Drawing Logic
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        drawLine(lastX, lastY, e.offsetX, e.offsetY, true);
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });

    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);

    function drawLine(x0, y0, x1, y1, emitEvent) {
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        ctx.closePath();

        if (emitEvent && socket) {
            const w = canvas.width;
            const h = canvas.height;
            socket.emit('draw', {
                room_id: currentRoom,
                x0: x0, y0: y0, x1: x1, y1: y1
            });
        }
    }

    function clearBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (socket) socket.emit('clear_board', { room_id: currentRoom });
    }
</script>
{% endblock %}