{% extends "base.html" %}

{% block title %}Smart Notes - StudySync Pro{% endblock %}
{% block header %}My Smart Notes üìù{% endblock %}

{% block content %}
<div class="dashboard-grid" style="grid-template-columns: 350px 1fr; gap: 2rem;">
    <!-- Notes Sidebar List -->
    <div class="glass-panel" style="padding: 1.5rem; display: flex; flex-direction: column; height: 80vh;">
        <div class="flex-between mb-1">
            <h3>All Notes</h3>
            <button class="btn btn-primary" onclick="createNewNote()"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div class="search-box mb-1">
            <input type="text" class="form-input" placeholder="Search notes..." id="searchNotes">
        </div>

        <div id="notesList" style="overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 0.8rem;">
            <!-- Notes will be loaded here -->
            <div class="text-center text-muted" style="padding: 2rem;">Loading...</div>
        </div>
    </div>

    <!-- Note Editor Area -->
    <div class="glass-panel"
        style="padding: 2rem; position: relative; height: 80vh; display: flex; flex-direction: column;">
        <div id="editorEmptyState"
            style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--col-text-muted);">
            <i class="fa-solid fa-book-open" style="font-size: 4rem; margin-bottom: 1.5rem;"></i>
            <h3>Select a note to view or create a new one</h3>
        </div>

        <form id="noteForm" style="display: none; height: 100%; flex-direction: column;">
            <input type="hidden" id="noteId">

            <div class="flex-between mb-1" style="border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                <input type="text" id="noteTitle" class="form-input" placeholder="Note Title"
                    style="font-size: 1.5rem; font-weight: bold; border: none; background: transparent; padding: 0;"
                    required>
                <div class="flex-center gap-sm">
                    <select id="courseSelect" class="form-input" style="width: auto; padding: 0.5rem;" required>
                        <option value="">Select Course</option>
                    </select>
                    <button type="button" class="btn btn-glass" style="color: #ef4444;" onclick="deleteCurrentNote()"><i
                            class="fa-solid fa-trash"></i></button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </div>

            <textarea id="noteContent" class="form-input" placeholder="Start typing your notes here..."
                style="flex: 1; border: none; background: transparent; resize: none; font-family: 'Inter', sans-serif; line-height: 1.6; padding: 1rem;"
                required></textarea>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentNotes = [];
    let currentNoteId = null;

    // Load initial data
    document.addEventListener('DOMContentLoaded', () => {
        loadCourses();
        loadNotes();
    });

    async function loadCourses() {
        try {
            const res = await fetch('/api/courses');
            const data = await res.json();
            const select = document.getElementById('courseSelect');
            select.innerHTML = '<option value="">Select Course</option>';
            data.courses.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.code + ' - ' + c.name;
                select.appendChild(opt);
            });
        } catch (e) { console.error('Error loading courses:', e); }
    }

    async function loadNotes() {
        try {
            const res = await fetch('/api/notes');
            const data = await res.json();
            currentNotes = data.notes;
            renderNotesList(currentNotes);
        } catch (e) {
            console.error('Error loading notes:', e);
            document.getElementById('notesList').innerHTML = '<div class="text-center text-error">Failed to load notes</div>';
        }
    }

    function renderNotesList(notes) {
        const list = document.getElementById('notesList');
        list.innerHTML = '';

        if (notes.length === 0) {
            list.innerHTML = `
                <div class="text-center text-muted" style="padding: 2rem;">
                    <p>No notes yet.</p>
                </div>`;
            return;
        }

        notes.forEach(note => {
            const div = document.createElement('div');
            div.className = `note-item glass-panel ${currentNoteId === note.id ? 'active' : ''}`;
            div.style.padding = '1rem';
            div.style.cursor = 'pointer';
            div.style.borderRadius = '12px';
            div.style.background = currentNoteId === note.id ? 'rgba(124, 58, 237, 0.2)' : 'rgba(255,255,255,0.03)';
            div.style.border = currentNoteId === note.id ? '1px solid var(--col-primary)' : '1px solid transparent';

            // Format date
            const date = new Date(note.updated_at).toLocaleDateString();

            div.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${note.title || 'Untitled'}</div>
                <div style="font-size: 0.8rem; color: var(--col-text-muted); display: flex; justify-content: space-between;">
                    <span><i class="fa-regular fa-clock"></i> ${date}</span>
                </div>
            `;

            div.onclick = () => selectNote(note);
            list.appendChild(div);
        });
    }

    function createNewNote() {
        currentNoteId = null;
        document.getElementById('editorEmptyState').style.display = 'none';
        document.getElementById('noteForm').style.display = 'flex';
        document.getElementById('noteId').value = '';
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteContent').value = '';
        document.getElementById('courseSelect').value = '';
        document.getElementById('noteTitle').focus();

        // Refresh list style
        renderNotesList(currentNotes);
    }

    function selectNote(note) {
        currentNoteId = note.id;
        document.getElementById('editorEmptyState').style.display = 'none';
        document.getElementById('noteForm').style.display = 'flex';

        document.getElementById('noteId').value = note.id;
        document.getElementById('noteTitle').value = note.title;
        document.getElementById('noteContent').value = note.content;
        document.getElementById('courseSelect').value = note.course_id || '';

        renderNotesList(currentNotes);
    }

    document.getElementById('noteForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('noteId').value;
        const title = document.getElementById('noteTitle').value;
        const content = document.getElementById('noteContent').value;
        const courseId = document.getElementById('courseSelect').value;

        if (!courseId) {
            showToast('Please select a course', 'error');
            return;
        }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/notes/${id}` : '/api/notes';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content, course_id: courseId })
            });

            if (res.ok) {
                showToast('Note saved successfully', 'success');
                loadNotes(); // Reload list
                if (!id) {
                    // If created new, we should probably select it, but for now just reload
                    currentNoteId = null;
                }
            } else {
                const data = await res.json();
                showToast(data.error || 'Failed to save note', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Error saving note', 'error');
        }
    });

    async function deleteCurrentNote() {
        if (!currentNoteId) return;

        if (!confirm('Are you sure you want to delete this note?')) return;

        try {
            const res = await fetch(`/api/notes/${currentNoteId}`, { method: 'DELETE' });
            if (res.ok) {
                showToast('Note deleted', 'success');
                currentNoteId = null;
                document.getElementById('editorEmptyState').style.display = 'flex';
                document.getElementById('noteForm').style.display = 'none';
                loadNotes();
            } else {
                showToast('Failed to delete note', 'error');
            }
        } catch (err) {
            showToast('Error deleting note', 'error');
        }
    }

    // Search Filter
    document.getElementById('searchNotes').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = currentNotes.filter(n =>
            (n.title && n.title.toLowerCase().includes(term)) ||
            (n.content && n.content.toLowerCase().includes(term))
        );
        renderNotesList(filtered);
    });
</script>
{% endblock %}